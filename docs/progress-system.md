# Progress System

## Current Model

Progress is local-first with background Firebase sync.

- Local storage key per course: `progress:{courseId}` (AsyncStorage)
- Remote storage doc per course: `users/{uid}/progress/{courseId}` (Firestore)
- Active client implementation: `src/api/user/FirebaseUserAPI.ts`

## Lesson ID Contract

Lesson IDs are generated by parser from lesson titles:

- Format: `{courseId}-{slugifiedLessonTitle}`
- Implemented in `functions/src/parseGoogleDoc.ts` via `slugify()` and lesson creation
- If source has `Course ID: course-...`, parser normalizes by removing `course-` prefix

Example:

- `Lesson - The Five Basic Positions` in `course-ballet-foundations` -> `ballet-foundations-the-five-basic-positions`

## If a Lesson Is Renamed

Renaming a lesson title changes slug and therefore lesson ID.

Impact:

- Existing users keep old completion under old lesson ID
- Renamed lesson appears as new/unstarted
- No automatic migration currently exists

## Lesson State Model

Defined in `src/api/user/UserAPI.ts`:

- `not-started`
- `in-progress`
- `completed`

Stored object:

- `LessonStatus` with `firstOpenedAt`, `lastAccessedAt`, optional `completedAt`

Derived object:

- `CourseProgress` computed at read time (counts, percentage, current lesson, completed IDs)

## Runtime Behavior

`LessonScreen` flow:

1. On load, if accessible, calls `markLessonOpened(courseId, lessonId)`
2. Completion triggers when:
   - user scroll reaches bottom threshold, or
   - content is shorter than viewport (auto-visible end)
3. Completion call: `markLessonCompleted(courseId, lessonId)`

## Sync Strategy (FirebaseUserAPI)

## Local-first Reads/Writes

- Writes: `markLessonOpened` / `markLessonCompleted` write local immediately, then `syncCourseInBackground()`
- Reads: `getLessonStatus` / `getCourseProgress` return local immediately, then background sync

## Anonymous Auth

- Uses Firebase anonymous auth (`signInAnonymously`) when needed
- Auth persistence is configured in `src/config/firebaseClient.ts` for React Native via AsyncStorage

## Migration

On first authenticated session per UID:

- Migrates local `progress:*` keys to Firestore
- Marks completion with `progress:migrated:{uid}`

## Conflict Resolution

Merge policy per lesson in `mergeMaps()`:

- Keep status with newer `lastAccessedAt`

## Resilience/Fallback

- Remote operations have timeouts
- On remote failure/timeouts, client enters 30-second local fallback window
- During fallback, UI remains functional on local data

## Cross-device Freshness

Progress appears on another device when that device next:

- focuses/reopens screens that call `getCourseProgress`/`getLessonStatus`
- and has network/auth available for remote merge

There is no live Firestore listener in current UI flow; refresh is pull-based on focus/load plus background sync.

## Known Limitation

`getAllCourseProgress()` infers `totalLessons` from stored lesson map size when full course totals are not provided. Screen-level code typically calls `getCourseProgress(courseId, lessonCount)` to use authoritative totals.
